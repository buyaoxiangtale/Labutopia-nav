# éšœç¢ç‰©å›¾ç‰‡ä¸åæ ‡è½¬æ¢è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [éšœç¢ç‰©å›¾ç‰‡çš„ä½œç”¨](#éšœç¢ç‰©å›¾ç‰‡çš„ä½œç”¨)
2. [å›¾ç‰‡åˆ°æ …æ ¼çš„è½¬æ¢](#å›¾ç‰‡åˆ°æ …æ ¼çš„è½¬æ¢)
3. [åæ ‡è½¬æ¢åŸç†](#åæ ‡è½¬æ¢åŸç†)
4. [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
5. [å®é™…ç¤ºä¾‹](#å®é™…ç¤ºä¾‹)

---

## ğŸ–¼ï¸ éšœç¢ç‰©å›¾ç‰‡çš„ä½œç”¨

### 1. éšœç¢ç‰©å›¾ç‰‡æ˜¯ä»€ä¹ˆï¼Ÿ

éšœç¢ç‰©å›¾ç‰‡ï¼ˆ`barrier_image_path`ï¼‰æ˜¯ä¸€ä¸ª**é»‘ç™½ä½å›¾**ï¼Œç”¨äºè¡¨ç¤ºåœºæ™¯ä¸­çš„è‡ªç”±ç©ºé—´å’Œéšœç¢ç‰©ï¼š

- **ç™½è‰²åƒç´  (255, 255, 255)** = è‡ªç”±ç©ºé—´ï¼Œæœºå™¨äººå¯ä»¥é€šè¡Œ
- **é»‘è‰²åƒç´  (0, 0, 0)** = éšœç¢ç‰©ï¼Œæœºå™¨äººä¸èƒ½é€šè¡Œ

### 2. ä¸ºä»€ä¹ˆéœ€è¦éšœç¢ç‰©å›¾ç‰‡ï¼Ÿ

1. **å¿«é€Ÿè·¯å¾„è§„åˆ’**ï¼šå°†è¿ç»­ç©ºé—´ç¦»æ•£åŒ–ä¸ºæ …æ ¼ï¼Œä¾¿äº A* ç®—æ³•æœç´¢
2. **å¯è§†åŒ–éšœç¢ç‰©**ï¼šç›´è§‚åœ°è¡¨ç¤ºåœºæ™¯å¸ƒå±€
3. **ç¢°æ’æ£€æµ‹**ï¼šå¿«é€Ÿåˆ¤æ–­æŸä¸ªä½ç½®æ˜¯å¦å¯è¡Œ
4. **å®‰å…¨è·ç¦»**ï¼šé€šè¿‡è†¨èƒ€æ“ä½œè€ƒè™‘æœºå™¨äººå°ºå¯¸

---

## ğŸ”„ å›¾ç‰‡åˆ°æ …æ ¼çš„è½¬æ¢

### æ­¥éª¤ 1ï¼šåŠ è½½å›¾ç‰‡

```python
# utils/a_star.py:64-75
def load_grid(image_path):
    """Convert image to binary grid representation."""
    with Image.open(image_path) as img:
        W, H = img.size  # è·å–å›¾ç‰‡å®½åº¦å’Œé«˜åº¦
        return (
            [
                [0 if is_white(img.getpixel((j, i))) else 1 for j in range(W)]
                for i in range(H)
            ],
            W,
            H,
        )
```

**è½¬æ¢è§„åˆ™**ï¼š
- ç™½è‰²åƒç´  â†’ `0`ï¼ˆè‡ªç”±ç©ºé—´ï¼‰
- éç™½è‰²åƒç´  â†’ `1`ï¼ˆéšœç¢ç‰©ï¼‰

**ç»“æœ**ï¼šå¾—åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼ˆæ …æ ¼åœ°å›¾ï¼‰
```
grid[i][j] = 0  â†’ è‡ªç”±ç©ºé—´
grid[i][j] = 1  â†’ éšœç¢ç‰©
```

### æ­¥éª¤ 2ï¼šåˆ¤æ–­åƒç´ é¢œè‰²

```python
# utils/a_star.py:78-83
def is_white(pixel):
    """Determine if pixel represents white space."""
    if isinstance(pixel, int):
        return pixel == 255
    channels = pixel[:3]
    return channels == (255, 255, 255)
```

### æ­¥éª¤ 3ï¼šéšœç¢ç‰©è†¨èƒ€

```python
# utils/a_star.py:86-89
def inflate_obstacles(grid: np.ndarray, radius: int) -> np.ndarray:
    from scipy.ndimage import binary_dilation
    struct = np.ones((2 * radius + 1, 2 * radius + 1))
    return binary_dilation(grid, structure=struct).astype(np.int32)
```

**ä½œç”¨**ï¼šåœ¨éšœç¢ç‰©å‘¨å›´å¢åŠ å®‰å…¨è·ç¦»ï¼Œè€ƒè™‘æœºå™¨äººçš„å°ºå¯¸

**ç¤ºä¾‹**ï¼š
- åŸå§‹éšœç¢ç‰©ï¼šå•ä¸ªåƒç´ 
- è†¨èƒ€åï¼ˆradius=5ï¼‰ï¼š5Ã—5 åƒç´ åŒºåŸŸ

---

## ğŸ“ åæ ‡è½¬æ¢åŸç†

### åæ ‡ç³»ç»Ÿ

ç³»ç»Ÿä¸­æœ‰**ä¸¤ä¸ªåæ ‡ç³»ç»Ÿ**ï¼š

1. **çœŸå®ä¸–ç•Œåæ ‡ï¼ˆReal World Coordinatesï¼‰**
   - å•ä½ï¼šç±³ (m)
   - èŒƒå›´ï¼šç”± `x_bounds` å’Œ `y_bounds` å®šä¹‰
   - ç¤ºä¾‹ï¼š`(0.0, 2.5)` è¡¨ç¤º X=0.0 ç±³ï¼ŒY=2.5 ç±³

2. **æ …æ ¼åæ ‡ï¼ˆGrid Coordinatesï¼‰**
   - å•ä½ï¼šåƒç´ ç´¢å¼•
   - èŒƒå›´ï¼š`[0, H-1] Ã— [0, W-1]`
   - ç¤ºä¾‹ï¼š`(100, 150)` è¡¨ç¤ºç¬¬ 100 è¡Œï¼Œç¬¬ 150 åˆ—

### è½¬æ¢å…¬å¼

#### 1. çœŸå®åæ ‡ â†’ æ …æ ¼åæ ‡

```python
# utils/a_star.py:92-100
def real_to_grid(x, y, x_bounds, y_bounds, grid_size):
    """Convert real coordinates to grid indices."""
    x_min, x_max = x_bounds
    y_min, y_max = y_bounds
    W, H = grid_size
    return (
        min(max(int((y_max - y) / (y_max - y_min) * H), 0), H - 1),
        min(max(int((x - x_min) / (x_max - x_min) * W), 0), W - 1),
    )
```

**æ•°å­¦å…¬å¼**ï¼š

**X æ–¹å‘**ï¼ˆåˆ—ç´¢å¼• jï¼‰ï¼š
```
j = (x - x_min) / (x_max - x_min) * W
```

**Y æ–¹å‘**ï¼ˆè¡Œç´¢å¼• iï¼‰ï¼š
```
i = (y_max - y) / (y_max - y_min) * H
```

**æ³¨æ„**ï¼š
- Y åæ ‡éœ€è¦åè½¬ï¼ˆ`y_max - y`ï¼‰ï¼Œå› ä¸ºå›¾ç‰‡åæ ‡åŸç‚¹åœ¨å·¦ä¸Šè§’
- ä½¿ç”¨ `min(max(..., 0), H-1)` ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…

#### 2. æ …æ ¼åæ ‡ â†’ çœŸå®åæ ‡

```python
# utils/a_star.py:103-111
def grid_to_real(i, j, x_bounds, y_bounds, grid_size):
    """Convert grid indices to real coordinates."""
    x_min, x_max = x_bounds
    y_min, y_max = y_bounds
    W, H = grid_size
    return (
        x_min + (j + 0.5) * (x_max - x_min) / W,
        y_max - (i + 0.5) * (y_max - y_min) / H,
    )
```

**æ•°å­¦å…¬å¼**ï¼š

**X åæ ‡**ï¼š
```
x = x_min + (j + 0.5) * (x_max - x_min) / W
```

**Y åæ ‡**ï¼š
```
y = y_max - (i + 0.5) * (y_max - y_min) / H
```

**æ³¨æ„**ï¼š
- `+ 0.5` è¡¨ç¤ºä½¿ç”¨æ …æ ¼å•å…ƒçš„ä¸­å¿ƒç‚¹
- Y åæ ‡åŒæ ·éœ€è¦åè½¬

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹å›¾ç¤º

```
1. åŠ è½½éšœç¢ç‰©å›¾ç‰‡
   lab_1.png (ä¾‹å¦‚: 1024Ã—512 åƒç´ )
        â†“
2. è½¬æ¢ä¸ºæ …æ ¼åœ°å›¾
   grid[512][1024] = [[0,0,1,...], [0,1,1,...], ...]
        â†“
3. éšœç¢ç‰©è†¨èƒ€
   inflated_grid (è€ƒè™‘æœºå™¨äººåŠå¾„ 0.6 ç±³)
        â†“
4. çœŸå®åæ ‡ â†’ æ …æ ¼åæ ‡
   èµ·ç‚¹: (0.0, 0.0) m â†’ (256, 256) åƒç´ 
   ç»ˆç‚¹: (5.0, 2.0) m â†’ (450, 180) åƒç´ 
        â†“
5. A* è·¯å¾„è§„åˆ’ï¼ˆåœ¨æ …æ ¼ä¸­ï¼‰
   è·¯å¾„: [(256,256), (257,256), ..., (450,180)]
        â†“
6. æ …æ ¼åæ ‡ â†’ çœŸå®åæ ‡
   è·¯å¾„: [(0.0,0.0), (0.05,0.0), ..., (5.0,2.0)]
        â†“
7. ç”Ÿæˆèˆªç‚¹åºåˆ—
   waypoints = [[x1,y1,Î¸1], [x2,y2,Î¸2], ...]
```

### ä»£ç å®ç°æµç¨‹

```python
# utils/a_star.py:137-175
def plan_navigation_path(task_info: dict):
    # æ­¥éª¤ 1: åŠ è½½å›¾ç‰‡å¹¶è½¬æ¢ä¸ºæ …æ ¼
    grid, W, H = load_grid(task_info['asset']['barrier_image_path'])
    
    # æ­¥éª¤ 2: è®¡ç®—åƒç´ åˆ°ç±³çš„æ¯”ä¾‹
    x_bounds = task_info['asset']['x_bounds']  # [-7.925, 9.175]
    y_bounds = task_info['asset']['y_bounds']  # [-1.525, 4.175]
    meters_per_pixel_x = (x_bounds[1] - x_bounds[0]) / W
    meters_per_pixel_y = (y_bounds[1] - y_bounds[0]) / H
    meters_per_pixel = min(meters_per_pixel_x, meters_per_pixel_y)
    
    # æ­¥éª¤ 3: è®¡ç®—è†¨èƒ€åŠå¾„ï¼ˆåƒç´ ï¼‰
    offset_radius = task_info['asset']['offset_radius']  # 0.6 ç±³
    radius_pixels = int(offset_radius / meters_per_pixel)
    
    # æ­¥éª¤ 4: éšœç¢ç‰©è†¨èƒ€
    inflated_grid = inflate_obstacles(grid, radius_pixels)
    
    # æ­¥éª¤ 5: çœŸå®åæ ‡ â†’ æ …æ ¼åæ ‡
    start = real_to_grid(
        task_info['start'][0], task_info['start'][1],
        x_bounds, y_bounds, (W, H)
    )
    end = real_to_grid(
        task_info['end'][0], task_info['end'][1],
        x_bounds, y_bounds, (W, H)
    )
    
    # æ­¥éª¤ 6: A* è·¯å¾„è§„åˆ’
    path_grid = astar(inflated_grid, start, end)
    
    # æ­¥éª¤ 7: æ …æ ¼åæ ‡ â†’ çœŸå®åæ ‡
    real_path = []
    for point in path_grid:
        real_x, real_y = grid_to_real(
            point[0], point[1],
            x_bounds, y_bounds, (W, H)
        )
        real_path.append([real_x, real_y, 0.0])
    
    return real_path, path_grid
```

---

## ğŸ“Š å®é™…ç¤ºä¾‹

### åœºæ™¯é…ç½®

```yaml
barrier_image_path: "assets/navigation/barrier/lab_1.png"
x_bounds: [-7.925, 9.175]  # X èŒƒå›´ï¼š17.1 ç±³
y_bounds: [-1.525, 4.175]  # Y èŒƒå›´ï¼š5.7 ç±³
offset_radius: 0.6  # å®‰å…¨åŠå¾„ï¼š0.6 ç±³
```

å‡è®¾å›¾ç‰‡å°ºå¯¸ï¼š`1024 Ã— 512` åƒç´ 

### è®¡ç®—æ­¥éª¤

#### 1. è®¡ç®—åƒç´ åˆ°ç±³çš„æ¯”ä¾‹

```
X æ–¹å‘ï¼šmeters_per_pixel_x = (9.175 - (-7.925)) / 1024
                      = 17.1 / 1024
                      â‰ˆ 0.0167 ç±³/åƒç´ 

Y æ–¹å‘ï¼šmeters_per_pixel_y = (4.175 - (-1.525)) / 512
                      = 5.7 / 512
                      â‰ˆ 0.0111 ç±³/åƒç´ 

å–æœ€å°å€¼ï¼šmeters_per_pixel = min(0.0167, 0.0111) = 0.0111 ç±³/åƒç´ 
```

#### 2. è®¡ç®—è†¨èƒ€åŠå¾„ï¼ˆåƒç´ ï¼‰

```
radius_pixels = 0.6 / 0.0111 â‰ˆ 54 åƒç´ 
```

#### 3. åæ ‡è½¬æ¢ç¤ºä¾‹

**çœŸå®åæ ‡ â†’ æ …æ ¼åæ ‡**ï¼š

èµ·ç‚¹ï¼š`(0.0, 0.0)` ç±³

```
j = (0.0 - (-7.925)) / (9.175 - (-7.925)) * 1024
  = 7.925 / 17.1 * 1024
  â‰ˆ 475

i = (4.175 - 0.0) / (4.175 - (-1.525)) * 512
  = 4.175 / 5.7 * 512
  â‰ˆ 375

æ …æ ¼åæ ‡ï¼š(375, 475)
```

ç»ˆç‚¹ï¼š`(5.0, 2.0)` ç±³

```
j = (5.0 - (-7.925)) / 17.1 * 1024
  = 12.925 / 17.1 * 1024
  â‰ˆ 774

i = (4.175 - 2.0) / 5.7 * 512
  = 2.175 / 5.7 * 512
  â‰ˆ 195

æ …æ ¼åæ ‡ï¼š(195, 774)
```

**æ …æ ¼åæ ‡ â†’ çœŸå®åæ ‡**ï¼š

æ …æ ¼åæ ‡ï¼š`(375, 475)`

```
x = -7.925 + (475 + 0.5) * 17.1 / 1024
  = -7.925 + 475.5 * 0.0167
  â‰ˆ 0.02 ç±³

y = 4.175 - (375 + 0.5) * 5.7 / 512
  = 4.175 - 375.5 * 0.0111
  â‰ˆ -0.00 ç±³

çœŸå®åæ ‡ï¼š(0.02, -0.00)
```

---

## ğŸ¯ å…³é”®è¦ç‚¹

### 1. åæ ‡ç³»ç»Ÿå·®å¼‚

- **å›¾ç‰‡åæ ‡ç³»**ï¼šåŸç‚¹åœ¨å·¦ä¸Šè§’ï¼ŒY è½´å‘ä¸‹
- **çœŸå®ä¸–ç•Œåæ ‡ç³»**ï¼šåŸç‚¹åœ¨å·¦ä¸‹è§’ï¼ŒY è½´å‘ä¸Š
- **è½¬æ¢æ—¶éœ€è¦åè½¬ Y åæ ‡**

### 2. æ …æ ¼å•å…ƒä¸­å¿ƒç‚¹

- è½¬æ¢æ—¶ä½¿ç”¨ `+ 0.5` è¡¨ç¤ºæ …æ ¼å•å…ƒçš„ä¸­å¿ƒ
- è¿™æ ·å¯ä»¥å‡å°‘åæ ‡è¯¯å·®

### 3. è¾¹ç•Œå¤„ç†

- ä½¿ç”¨ `min(max(..., 0), size-1)` ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
- é˜²æ­¢æ•°ç»„è¶Šç•Œé”™è¯¯

### 4. ç²¾åº¦è€ƒè™‘

- å›¾ç‰‡åˆ†è¾¨ç‡è¶Šé«˜ï¼Œåæ ‡ç²¾åº¦è¶Šé«˜
- ä½†è®¡ç®—é‡ä¹Ÿä¼šå¢åŠ 
- éœ€è¦å¹³è¡¡ç²¾åº¦å’Œæ€§èƒ½

---

## ğŸ’¡ æ€»ç»“

1. **éšœç¢ç‰©å›¾ç‰‡**ï¼šå°†åœºæ™¯å¸ƒå±€è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ …æ ¼åœ°å›¾
2. **åæ ‡è½¬æ¢**ï¼šåœ¨çœŸå®ä¸–ç•Œåæ ‡å’Œæ …æ ¼åæ ‡ä¹‹é—´åŒå‘è½¬æ¢
3. **è·¯å¾„è§„åˆ’**ï¼šåœ¨æ …æ ¼åœ°å›¾ä¸Šä½¿ç”¨ A* ç®—æ³•æ‰¾åˆ°è·¯å¾„
4. **ç»“æœè½¬æ¢**ï¼šå°†æ …æ ¼è·¯å¾„è½¬æ¢å›çœŸå®ä¸–ç•Œåæ ‡

æ•´ä¸ªè¿‡ç¨‹å®ç°äº†ä»è¿ç»­ç©ºé—´åˆ°ç¦»æ•£ç©ºé—´çš„æ˜ å°„ï¼Œä½¿å¾—è·¯å¾„è§„åˆ’ç®—æ³•èƒ½å¤Ÿé«˜æ•ˆå·¥ä½œã€‚

